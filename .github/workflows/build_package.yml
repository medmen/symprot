name: Build & Deploy Symfony Package

on:
  push:
    branches:
      - '**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, xml, ctype, iconv, json
          tools: composer, symfony

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Build Symfony package (customize as needed)
        run: |
          mkdir -p build
          VERSION=$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}
          PACKAGE_NAME="symfony-package-${VERSION}.zip"
          zip -r "build/$PACKAGE_NAME" . -x ".git/*" "vendor/*" "build/*"
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: build/${{ env.PACKAGE_NAME }}

      - name: Cleanup old package artifacts (keep latest 10)
        run: |
          sudo apt-get install jq -y
          REPO="${{ github.repository }}"
          ARTIFACTS=$(gh api repos/$REPO/actions/artifacts | jq -c '.artifacts')
          COUNT=$(echo $ARTIFACTS | jq 'length')
          if [ "$COUNT" -gt 10 ]; then
            IDS=$(echo $ARTIFACTS | jq 'sort_by(.created_at) | reverse | .[10:] | .[].id')
            for ID in $IDS; do
              echo "Deleting artifact ID: $ID"
              gh api --method DELETE repos/$REPO/actions/artifacts/$ID
            done
          else
            echo "Less than or equal to 10 artifacts, nothing to delete"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Optional: Deploy step can be added here if you need to publish somewhere
