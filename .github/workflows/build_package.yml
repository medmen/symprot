name: Nightly Build & Release
permissions:
  contents: write

on:
  push:
    branches:
      - '**'

jobs:
  build-and-release:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, xml, ctype, iconv, json
          tools: composer, symfony

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Build assets (production)
        run: |
          composer dump-env prod
          # The following commands are best-effort to avoid CI failures if DB/services are not available
          bin/console about --env=prod || true
          vendor/bin/requirements-checker || true
          bin/console doctrine:database:create
          bin/console doctrine:migrations:migrate
          bin/console seed:load
          bin/console asset-map:compile || true
          bin/console cache:clear --env=prod || true

      - name: Compute metadata
        id: meta
        shell: bash
        run: |
          DATE=$(date -u +%Y%m%d)
          TIME=$(date -u +%H%M%S)
          SHORT_SHA=${GITHUB_SHA::7}
          TAG="nightly-$DATE"
          REL_NAME="Nightly $DATE"
          PKG_NAME="symprot-nightly-${DATE}-${TIME}-${SHORT_SHA}.zip"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "release_name=$REL_NAME" >> "$GITHUB_OUTPUT"
          echo "package_name=$PKG_NAME" >> "$GITHUB_OUTPUT"

      - name: Create package archive
        run: |
          mkdir -p build
          zip -r "build/${{ steps.meta.outputs.package_name }}" . \
            -x ".git/*" "vendor/*" "build/*" "node_modules/*" \
               ".github/*" "var/*"

      - name: Create/update nightly release and upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.release_name }}
          make_latest: false
          prerelease: true
          files: |
            build/${{ steps.meta.outputs.package_name }}
          generate_release_notes: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old nightly releases (keep latest 10)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const releases = await github.paginate(github.rest.repos.listReleases, { owner, repo, per_page: 100 });
            const nightlies = releases.filter(r => r.tag_name && r.tag_name.startsWith('nightly-'))
                                      .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            const toDelete = nightlies.slice(10);
            for (const rel of toDelete) {
              core.info(`Deleting old nightly release: ${rel.tag_name} (${rel.id})`);
              await github.rest.repos.deleteRelease({ owner, repo, release_id: rel.id });
              // try delete tag
              const ref = `tags/${rel.tag_name}`;
              try {
                await github.rest.git.deleteRef({ owner, repo, ref });
              } catch (e) {
                core.warning(`Could not delete ref ${ref}: ${e.message}`);
              }
            }

    # Optional: Add further deployment steps if needed
