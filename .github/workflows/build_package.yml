name: Build & Deploy Symfony Package
permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - '**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, xml, ctype, iconv, json
          tools: composer, symfony

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Build assets and preseed DB in production mode
        run: |
          composer dump-env prod
          bin/console about --env=prod
          vendor/bin/requirements-checker
          bin/console doctrine:database:create
          bin/console doctrine:migrations:migrate
          bin/console seed:load
          bin/console asset-map:compile
          bin/console cache:clear --env=prod

      - name: Build Symfony package (customize as needed)
        run: |
          set -euo pipefail
          mkdir -p build
          BRANCH="${GITHUB_REF##*/}"
          # Sanitize branch for package name (replace slashes and spaces)
          SAFE_BRANCH=$(echo "$BRANCH" | sed -E 's#[^A-Za-z0-9._-]#-#g')
          # Include 'nightly' in version so cleanup can filter correctly
          VERSION="nightly-$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}"
          PKG_NAME="symprot-${SAFE_BRANCH}"
          ASSET_NAME="${PKG_NAME}-${VERSION}.zip"

          zip -r "build/$ASSET_NAME" . -x ".git/*" "vendor/*" "build/*"

          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"
          echo "SAFE_BRANCH=$SAFE_BRANCH" >> "$GITHUB_ENV"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "PKG_NAME=$PKG_NAME" >> "$GITHUB_ENV"
          echo "ASSET_NAME=$ASSET_NAME" >> "$GITHUB_ENV"

      - name: Publish nightly artifact to GitHub Packages
        run: |
          set -euo pipefail
          echo "Publishing $ASSET_NAME to GitHub Packages (generic) as nightly..."
          URL="https://uploads.github.com/repos/${{ github.repository }}/packages/generic/${{ env.PKG_NAME }}/${{ env.VERSION }}/${{ env.ASSET_NAME }}"
          echo "PUT $URL"
          curl -sS -X PUT \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/zip" \
            --data-binary "@build/${{ env.ASSET_NAME }}" \
            "$URL"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Note: This uses the GitHub REST API for generic package uploads.
        # For advanced Composer (PHP) package publishing, consider using Composer+auth.json or other package registries.

      - name: Cleanup old nightly packages (keep only latest 10)
        run: |
          set -euo pipefail
          # Install jq and gh if missing
          sudo apt-get update -y
          sudo apt-get install -y jq gh

          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          PACKAGE_NAME="${{ env.PKG_NAME }}"

          echo "Repository: $REPO"
          echo "Owner: $OWNER"
          echo "Package: $PACKAGE_NAME"

          # Determine owner type (Organization or User) via repo metadata
          OWNER_TYPE=$(gh api "repos/$REPO" | jq -r '.owner.type')
          if [ "$OWNER_TYPE" = "Organization" ]; then
            BASE="orgs/$OWNER"
          else
            BASE="users/$OWNER"
          fi
          echo "Resolved API base: $BASE"

          # List generic packages for the owner (org/user)
          gh api "$BASE/packages?package_type=generic" > packages.json || {
            echo "Failed to list packages for $BASE"; cat packages.json || true; exit 0; }

          # Find the package ID for our package
          PKG_ID=$(jq -r '[.[] | select(.name == '"$PACKAGE_NAME"')] | first | .id // empty' packages.json)
          if [ -z "${PKG_ID:-}" ]; then
            echo "No package named $PACKAGE_NAME found under $BASE. Nothing to clean."
            exit 0
          fi
          echo "Found package ID: $PKG_ID"

          # List all versions of our package
          gh api "$BASE/packages/generic/$PACKAGE_NAME/versions" > versions.json

          # Filter only nightly versions (name contains 'nightly')
          NIGHTLY_VERSIONS=$(jq '[.[] | select(.name | test("nightly"))]' versions.json)
          COUNT=$(echo "$NIGHTLY_VERSIONS" | jq 'length')

          echo "Nightly versions found: $COUNT"
          if [ "$COUNT" -le 10 ]; then
            echo "Nothing to clean up, nightly versions: $COUNT"
            exit 0
          fi

          # Get IDs of older nightly versions (all except 10 newest)
          IDS=$(echo "$NIGHTLY_VERSIONS" | jq 'sort_by(.created_at) | reverse | .[10:] | .[].id')

          for ID in $IDS; do
            echo "Deleting old nightly package version ID: $ID"
            gh api --method DELETE "$BASE/packages/generic/$PACKAGE_NAME/versions/$ID"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


    # Optional: Deploy step can be added here if you need to publish somewhere
