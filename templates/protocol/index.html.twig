{% extends 'base.html.twig' %}

{% block title %}Protokoll Ausgabe - {{ geraet }}{% endblock %}

{% block body %}
    <form method="get" target="./">
        <input type="submit" name="format"
               class="button" value="html" />

        <input type="submit" name="format"
               class="button" value="md" label="markdown" />
    </form>

    {% if jobId is defined %}
        <div id="progress_bar" style="position: relative; width: 100%; height: 22px; background: #eee; border-radius: 6px; overflow: hidden; margin: 10px 0 20px 0;">
            <div class="fill" style="height: 100%; width: 0%; background: #4caf50;"></div>
            <span class="label" style="position: absolute; left: 50%; top: 0; transform: translateX(-50%); font-size: 12px; line-height: 22px; color: #000;">0%</span>
        </div>
        <div id="progress_msg" class="text-muted" style="margin-bottom: 10px;">Wird verarbeitetâ€¦</div>
    {% endif %}

    <div class="output-wrapper" id="protocol_output">
        {{ output|raw }}
    </div>

    {% if jobId is defined %}
        <script nonce="{{ csp_nonce('script') }}">
            (function(){
                var jobId = {{ jobId|json_encode|raw }};
                var bar = document.getElementById('progress_bar');
                var fill = bar ? bar.querySelector('.fill') : null;
                var label = bar ? bar.querySelector('.label') : null;
                var msg = document.getElementById('progress_msg');
                var out = document.getElementById('protocol_output');
                var done = false;
                function setPct(p){ if(!fill||!label)return; var pct=Math.max(0,Math.min(100,Math.round(p))); fill.style.width=pct+'%'; label.textContent=pct+'%'; }
                function poll(){
                    if(done) return;
                    fetch('{{ path('process_status', {'id':'__ID__'})|e('js') }}'.replace('__ID__', jobId), {credentials:'same-origin'})
                        .then(function(r){ return r.json(); })
                        .then(function(s){
                            if(s.percent!=null) setPct(s.percent);
                            if(msg && s.message) msg.textContent = s.message;
                            if(s.status === 'done'){
                                done = true;
                                if(msg) msg.textContent = 'Fertig';
                                fetch('{{ path('process_output', {'id':'__ID__'})|e('js') }}'.replace('__ID__', jobId), {credentials:'same-origin'})
                                    .then(function(r){ return r.text(); })
                                    .then(function(html){ if(out){ out.innerHTML = html; } });
                            } else if(s.status === 'failed'){
                                done = true;
                                if(msg) msg.textContent = 'Fehler: ' + (s.error || 'Unbekannt');
                                if(out){ out.innerHTML = '<div class="alert alert-danger">Verarbeitung fehlgeschlagen: '+(s.error||'Unbekannt')+'</div>'; }
                            } else {
                                setTimeout(poll, 1000);
                            }
                        })
                        .catch(function(){ setTimeout(poll, 1500); });
                }
                poll();
            })();
        </script>
    {% endif %}
{% endblock %}
